<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>
    
Project: Dykes on Piper Thunstrom's Blog

  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="
  A resource for conference organizers deciding on what to include in your media kit.
">
  <!-- Styles. -->
  <link href="/static/styles/reset.css" type="text/css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bree+Serif&family=Comfortaa&family=Source+Code+Pro&display=swap" rel="stylesheet">
  <link href="/static/styles/base.css" type="text/css" rel="stylesheet">
  
  <link href="/static/styles/author.css" type="text/css" rel="stylesheet">
  <link href="/static/styles/article.css" type="text/css" rel="stylesheet">

  <link rel="icon" href="/static/img/avatars/piper.jpeg" type="image/x-icon" />
  <link href="https://ngmx.com/@pathunstrom" rel="me">
</head>
<body>
  <div class="headshot">
  <img class="full-img" src="/static/img/headshot.jpg" width=1242 height=1740 alt="A headshot of Piper Thunstrom">
  <img class="sqr-img" src="/static/img/headshot-square.jpg" width=1242 height=1243 alt="A headshot of Piper Thunstrom">
</div>
  <header class="title">
  <h1>Piper Thunstrom</h1>
  
</header>
  <div class="body-content">
    
  
    <article class="post" id="project-dykes">
  <header class="image-container"><img src="/static/img/headers/laser-hall.png" width=1200 height=627 alt="A hallway with multiple colored lasers."></header>
  <section>
    <h2>Project: Dykes</h2>
    <div class="article-content">
        <p>I'm one of those developers that likes writing little scripts for my own use.
Things like a custom budgeting tool.
Or a word counter.
Actually I write a lot of word counters.
Custom ones for different kinds of writing.</p>
<p>While writing a new word counter, I tried using <code>Protocol</code> and <code>cast</code> to get a typed namespace from <code>argparse</code>.
It was a surprisingly simple solution to a problem.
I idly <a href="https://ngmx.com/@pathunstrom/114611226324385652">mentioned it on fedi</a> and that started a conversation about arg parsing for simple scripts.</p>
<p>I'm an actual fan of <code>argparse</code>.
I think it's great, even with the significant number of warts.
I will also be the first to admit that its learning curve looks like a cliff.</p>
<p>I'm not a fan of tools like <code>click</code>, but honestly it's probably a philosophical difference.
It's a good tool that helps build good tools.</p>
<p>Other argparse tools that give type information tend to use metaprogramming and other magic.
I like certain kinds of python magic, but "this does a thing without looking like it's doing a thing" is not my preference.</p>
<p>So I slapped together an idea.</p>
<p>A 13 line module did the same basic thing as my Protocol + cast method,
but gave you a real type out.
It was just an adapter function wrapped around argparse.</p>
<p>One of the regular problems I see in <code>argparse</code> wrappers is failure to manage the basic use cases.
Like app descriptions.
Or parameter help strings.</p>
<p>Thus started dykes.</p>
<h3 id="project-dykes">Project: Dykes</h3>
<p><code>dykes</code> is a simple argument parser that does very little "magic".</p>
<p>Build your arguments as a dataclass or <code>NamedTuple</code> and pass to the parse_args function.</p>
<p>Get back an instance of your type to use as you see fit.</p>
<p>A sample application:</p>
<pre><code>from dataclasses import dataclass
from pathlib import Path
from typing import Annotated

import dykes


@dataclass
class ExampleApplication:
    """
    This is a sample script that operates on a file on disk.
    """
    path: Annotated[Path, "The paths to operate on."]
    dry_run: bool
    prompt: dykes.StoreFalse
    verbosity: dykes.Count


if __name__ == "__main__":
    arguments = dykes.parse_args(ExampleApplication)
    print(arguments)
</code></pre>
<p>Skip saying everything twice, get the benefits of type hinting, and enjoy.</p>
<p>You can get it with pip: <code>pip install dykes</code>.
Or you can go <a href="https://github.com/pathunstrom/dykes">grab the code on github</a>.</p>
<p>It's MIT licensed, and I hope it helps.</p>
<p>The rest of this article is talking about the moving parts and how I developed them.</p>
<h3 id="how-it-got-made">How it got made</h3>
<p>Dykes first code contribution started as that thirteen line module.</p>
<pre><code>import argparse
from dataclasses import dataclass
from sys import argv
from typing import get_type_hints

def simple_args[ArgsType](parameter_definition: type[ArgsType], args: list = None) -&gt; ArgsType:
    if args is None:
        args = argv
    parser = argparse.ArgumentParser()
    hints = get_type_hints(parameter_definition)
    for name, cls in hints.items():
        parser.add_argument(name, type=cls)
    parsed = parser.parse_args(args)
    return parameter_definition(**parsed.__dict__)
</code></pre>
<p>Called <code>simple_parser</code> at first, I wanted to focus on the big chunk of things I expect to want to put into argparse.</p>
<p>I wanted to be able to use the <code>type</code> parameter to coerce strings to relevant types.
I had to support app descriptions and help strings.
Boolean flags and counted flags both needed support out of the box.</p>
<p>The first feature was done in my micro sample.</p>
<h3 id="descriptions-and-help-strings">Descriptions and Help Strings</h3>
<p>The first challenge was app description.</p>
<p>I chose doc strings as my methodology for applying the app description.</p>
<p>Effectively:</p>
<pre><code>import dataclasses
from pathlib import Path

@dataclasses.dataclass
class Application:
    """
    Counts words in a markdown file, skipping horizontal rules and headings.
    """
    path: Path
</code></pre>
<p>Should put the doc string into the <code>--help</code> text for the application.</p>
<p>This was relatively simple to produce, as the <code>inspect</code> module has a <code>getdoc</code> function.
<code>argparse</code> automatically strips extra white space and formats it.</p>
<p>Testing this was challenging, though, as you couldn't control how argparse wraps the text.
I have a test case with multiple newlines.</p>
<p>The trick, for those interested, was to check <code>ArgumentParser.description</code> instead of the <code>format_help</code> output.</p>
<p>Help strings, on the other hand, were a bit more challenging.</p>
<p>I settled on using <code>typing.Annotated</code> to produce the right effect.</p>
<p>To update the previous example:</p>
<pre><code>import dataclasses
from pathlib import Path
from typing import Annotated

@dataclasses.dataclass
class Application:
    """
    Counts words in a markdown file, skipping horizontal rules and headings.
    """
    path: Annotated[Path, "The file to count."]
</code></pre>
<p>To get the annotations, you need two tools: <code>typing.get_type_hints</code> and the <code>Annotated.__metadata__</code> attribute.</p>
<p>I was already getting the type hints, so I needed to check if a type was <code>Annotated</code> and pull off a bare string value.
Usefully, <code>Annotated</code> types can be used as the wrapped type directly (and thus needed no special preparation when passed to <code>argparse</code>).</p>
<p>Now we got automated help messages that could include human generated text!</p>
<h3 id="booleans-and-counts">Booleans and Counts</h3>
<p>The next step was making sure we could use <code>bool</code> to get basic flags works.
I made a decision that a type hint of bool with no default would be a <code>"store_true"</code> action.
I also wanted to expose <code>"store_false"</code>.</p>
<p>The first thing I did was add a check on the type hint.
If we had a boolean, default the action to <code>Action.STORE_TRUE</code>.</p>
<p>That was relatively straight forward, but how about <code>Action.STORE_FALSE</code>.
I had written the <code>Action</code> <code>StrEnum</code> previously that included all the actions for <code>argparse</code>.
I already was checking the <code>__metadata__</code> for <code>Annotated</code> so attempted just plugging an <code>Action</code> value in.
With a bit of conditionals to check the <code>__metadata__</code> type, I could verify that I had a string enum first and then a string to differentiate between them.
And thus, <code>Annotated[bool, Action.STORE_FALSE]</code> was a valid way to describe that.</p>
<p><code>"count"</code> followed a similar path. <code>Annotated[int, Action.COUNT]</code> did the right thing.
The problem is the ergonomics weren't great.</p>
<p>I realized I could prebuild these types, since nested <code>Annotated</code> types flatten.</p>
<p>So I wrote <code>dykes.StoreTrue</code>, <code>dykes.StoreFalse</code>, and <code>dykes.Count</code>, all of which were <code>Annotated</code> with the right type and action.
Annotate them further with a string and you got all the benefits.</p>
<p>All of those features were part of the first "real" release.
Good for the simplest scripts, but missing a key feature: number of arguments.</p>
<h3 id="nargs">NArgs</h3>
<p>This took longer than basically every other feature.
Part of it was we were hitting the point where the naive approaches were starting to be a burden.
It also meant making a decision on how to apply extra arguments generally.</p>
<p>First, I handled the most simple case: A positional argument typed <code>list[T]</code>.
This meant looking for that list type and changing <code>nargs</code> to <code>+</code>.
Philosophically, the "simple" case is always "I expect some input, and will fail if I don't get it."</p>
<p>To support the other nargs cases, I decided to lean into the Annotation system.
<code>ArgumentParser.add_argument</code> is an extremely flexible function with a bunch of odd foot-guns.
Everything expects to be a keyword, but making sure everything is the "right shape" can cause issues.</p>
<p>I decided on an architecture where I extract the basics from the type system, then use specific Annotated types to produce the arguments.
After I've collected all the arguments, I remove any problematic features (a default for <code>"store_true"</code> for example).
Then I pass the dictionary of arguments to <code>add_argument</code>.</p>
<p>This meant <code>NArgs</code> is a simple type with a single attribute: <code>value</code>.
I type hinted this specifically: <code>Literal["*", "+", "?"] | int</code>.
Now you just add NArgs to an Annotated type (anywhere in the metadata!) and you'd get the right thing.</p>
<p>A positional argument (so a name with no <code>Action</code>) could be typed in a couple of ways:</p>
<pre><code>@dataclass
class Application:
    numbers: Annotated[list[float], dykes.NArgs(*)] = dataclasses.field(default_factory=lambda: [1, 2, 3])
</code></pre>
<p>This allows you to do any number of arguments (including zero!) and provided a default.
Yes, you use default factory as dataclass expects, and dykes extracts that for you.</p>
<p>You can also get a single optional argument:</p>
<pre><code>@dataclass
class Application:
    path: Annotated[Path, dykes.NArgs(?)] = Path(".")
</code></pre>
<p>At this point, most of the other actions are available (though may not work <em>quite</em> right.)</p>
<p>As I work through this, I want to support customizing the short and long flags and the other options to add_argument.</p>
<p>Hope some of this rambling is useful to others.
Feel free to peruse the code if you're interested in more details.</p>
<p>Tag me on fedi @pathunstrom@ngmx.com.</p>
    </div>
  </section>
  <footer>
    
      <div class="author">
  <img class="author__image" src="/static/img/avatars/piper.jpeg" alt="Avatar for Piper Thunstrom">
  <p class="author__name">Piper Thunstrom</p>
  <p class="author__bio">Piper is a pythonista, game enthusiast, and web developer. She's the author and maintainer of ppb and misbehave. She also edits books and gives talks.</p>
</div>
    
  </footer>
</article>
  

  </div>
  <nav class="main-nav">
  <ul>
    <li><a href=/>Home</a></li>
    <li><a href=/blog/>Blog</a></li>
  </ul>
</nav>

  <ul class="link-tree">
      
          <li><a href="https://ngmx.com/@pathunstrom" class="icon-link">
    <img src="/static/img/icons/Fediverse_logo_white.svg" alt="NGMX.com on the Fediverse">
</a></li>
      
          <li><a href="https://github.com/pathunstrom" class="icon-link">
    <img src="/static/img/icons/github-white.png" alt="Piper Thunstrom on Github">
</a></li>
      
          <li><a href="https://www.patreon.com/pathunstrom?fan_landing=true" class="icon-link">
    <img src="/static/img/icons/patreon-white.png" alt="Piper Thunstrom on Patreon">
</a></li>
      
          <li><a href="https://bsky.app/profile/pathunstrom.bsky.social" class="icon-link">
    <img src="/static/img/icons/bluesky_media_kit_logo_transparent_2.png" alt="Piper Thunstron on Blue Sky">
</a></li>
      
  </ul>

</body>
</html>